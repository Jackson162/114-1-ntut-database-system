{% extends "admin/base.jinja" %}

{% block extra_head %}
<style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
    th { background-color: #f8f9fa; }
    .status-active { color: green; font-weight: bold; }
    .status-inactive { color: red; font-weight: bold; }
    .btn { padding: 6px 12px; cursor: pointer; border-radius: 4px; border: none; font-size: 14px; margin-right: 5px; }
    .btn-edit { background-color: #ffc107; color: #000; }
    .btn-toggle { background-color: #17a2b8; color: white; }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
    .modal-content { background: white; width: 400px; margin: 100px auto; padding: 20px; border-radius: 8px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 8px; box-sizing: border-box; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>使用者帳號管理</h2>
    <table>
        <thead>
            <tr>
                <th>使用者帳號 (ID)</th>
                <th>使用者姓名</th>
                <th>電子信箱</th>
                <th>帳號狀態</th>
                <th>管理操作</th>
            </tr>
        </thead>
        <tbody>
            {% for user in customers %}
            <tr>
                <td>{{ user.account }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email or '-' }}</td>
                <td>
                    {% if user.is_active %}
                    <span class="status-active">啟用</span>
                    {% else %}
                    <span class="status-inactive">停用</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-edit" onclick="openEditModal('{{ user.account }}', '{{ user.name }}', '{{ user.email or '' }}')">編輯</button>
                    <button class="btn btn-toggle" onclick="toggleStatus('{{ user.account }}', {{ 'true' if user.is_active else 'false' }})">
                        {{ '停用' if user.is_active else '啟用' }}
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>編輯使用者帳號</h3>
        <input type="hidden" id="editAccount">
        <div class="form-group">
            <label>使用者姓名</label>
            <input type="text" id="editName">
        </div>
        <div class="form-group">
            <label>電子信箱</label>
            <input type="email" id="editEmail">
        </div>
        <div style="text-align: right;">
            <button class="btn" onclick="closeEditModal()">取消</button>
            <button class="btn" style="background-color: #28a745; color: white;" onclick="saveUser()">儲存</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function toggleStatus(account, currentStatus) {
        if (!confirm('確定要' + (currentStatus ? '停用' : '啟用') + '此帳號嗎？')) return;
        
        try {
            const res = await fetch(`/admin/users/${account}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_active: !currentStatus })
            });
            if (res.ok) {
                location.reload();
            } else {
                alert('操作失敗');
            }
        } catch (e) {
            alert('Error');
        }
    }

    function openEditModal(account, name, email) {
        document.getElementById('editAccount').value = account;
        document.getElementById('editName').value = name;
        document.getElementById('editEmail').value = email;
        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function saveUser() {
        const account = document.getElementById('editAccount').value;
        const name = document.getElementById('editName').value;
        const email = document.getElementById('editEmail').value;
        
        try {
            const res = await fetch(`/admin/users/${account}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email })
            });
            if (res.ok) {
                location.reload();
            } else {
                alert('更新失敗');
            }
        } catch (e) {
            alert('Error');
        }
    }
</script>
{% endblock %}