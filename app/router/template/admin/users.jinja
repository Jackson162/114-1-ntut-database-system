{% extends "admin/base.jinja" %}

{% block extra_head %}
<style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 40px; }
    th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
    th { background-color: #f8f9fa; }
    .btn { padding: 6px 12px; cursor: pointer; border-radius: 4px; border: none; font-size: 14px; margin-right: 5px; }
    .btn-edit { background-color: #ffc107; color: #000; }
    .btn-delete { background-color: #dc3545; color: white; }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
    .modal-content { background: white; width: 400px; margin: 100px auto; padding: 20px; border-radius: 8px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group input { width: 100%; padding: 8px; box-sizing: border-box; }
    
    h2 { margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #eee; }
    .section-title { margin-top: 30px; color: #333; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2 class="section-title">一般使用者 (Customers)</h2>
    <table>
        <thead>
            <tr>
                <th>帳號 (Account)</th>
                <th>姓名 (Name)</th>
                <th>電子信箱 (Email)</th>
                <th>管理操作</th>
            </tr>
        </thead>
        <tbody>
            {% for user in customers %}
            <tr>
                <td>{{ user.account }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email or '-' }}</td>
                <td>
                    <button class="btn btn-edit" onclick="openEditModal('{{ user.account }}', '{{ user.name }}', '{{ user.email or '' }}')">編輯</button>
                    <button class="btn btn-delete" onclick="deleteUser('{{ user.account }}', 'customer')">刪除</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 class="section-title">員工 (Staffs)</h2>
    <table>
        <thead>
            <tr>
                <th>帳號 (Account)</th>
                <th>姓名 (Name)</th>
                <th>所屬書店 (Bookstore ID)</th>
                <th>管理操作</th>
            </tr>
        </thead>
        <tbody>
            {% for staff in staffs %}
            <tr>
                <td>{{ staff.account }}</td>
                <td>{{ staff.name }}</td>
                <td>{{ staff.bookstore_id or '無' }}</td>
                <td>
                    <button class="btn btn-delete" onclick="deleteUser('{{ staff.account }}', 'staff')">刪除</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>編輯使用者帳號</h3>
        <input type="hidden" id="editAccount">
        <div class="form-group">
            <label>使用者姓名</label>
            <input type="text" id="editName">
        </div>
        <div class="form-group">
            <label>電子信箱</label>
            <input type="email" id="editEmail">
        </div>
        <div style="text-align: right;">
            <button class="btn" onclick="closeEditModal()">取消</button>
            <button class="btn" style="background-color: #28a745; color: white;" onclick="saveUser()">儲存</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function deleteUser(account, type) {
        const typeName = type === 'customer' ? '使用者' : '員工';
        if (!confirm(`確定要刪除此${typeName} (${account}) 嗎？此操作無法復原。`)) return;
        
        const endpoint = type === 'customer' ? `/admin/users/${account}` : `/admin/staffs/${account}`;
        
        try {
            const res = await fetch(endpoint, {
                method: 'DELETE',
            });
            if (res.ok) {
                location.reload();
            } else {
                alert('刪除失敗');
            }
        } catch (e) {
            console.error(e);
            alert('發生錯誤');
        }
    }

    function openEditModal(account, name, email) {
        document.getElementById('editAccount').value = account;
        document.getElementById('editName').value = name;
        document.getElementById('editEmail').value = email;
        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function saveUser() {
        const account = document.getElementById('editAccount').value;
        const name = document.getElementById('editName').value;
        const email = document.getElementById('editEmail').value;
        
        try {
            const res = await fetch(`/admin/users/${account}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email })
            });
            if (res.ok) {
                location.reload();
            } else {
                alert('更新失敗');
            }
        } catch (e) {
            alert('Error');
        }
    }
</script>
{% endblock %}